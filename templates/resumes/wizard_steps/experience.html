{# templates/resumes/wizard_steps/experience.html #}
{% extends 'resumes/wizard_base.html' %}
{% load static %}
{% load widget_tweaks %} {# Make sure widget_tweaks is loaded #}

{% block step_title %}Work Experience{% endblock %}
{% block step_icon %}<i class="fa-solid fa-briefcase mr-3 text-primary opacity-80"></i>{% endblock %}

{% block step_content %}
<form id="resume-form" method="post" action="{% url 'job_portal:resume_wizard' step=step %}">
    {% csrf_token %}

    {# *** Management Form *** #}
    {{ formset.management_form }}

    <div class="flex flex-col md:flex-row gap-6">
        <div class="w-full md:w-2/3">
            <div id="experiences_container" class="space-y-6">

                {# Loop over formset.forms #}
                {% for form in formset.forms %}
                <div class="form-row bg-base-100 border border-gray-100 dark:border-gray-700 rounded-xl shadow-lg p-6 experience-entry" id="{{ form.prefix }}-row" data-index="{{ forloop.counter0 }}">
                    {# Hidden fields #}
                    {# {{ form.id }} #} {# Only needed if using modelformset and referencing existing instances #}
                    {% if formset.can_delete %}
                        <div class="hidden">{{ form.DELETE }}</div>
                    {% endif %}

                    <div class="flex justify-between items-center mb-5 pb-3 border-b border-gray-100 dark:border-gray-700">
                        <h3 class="text-lg font-medium flex items-center">
                            <span class="w-9 h-9 rounded-full bg-primary/15 flex items-center justify-center mr-3 shadow-sm"><i class="fa-solid fa-briefcase text-primary text-sm"></i></span>
                            <span class="text-gray-800 dark:text-gray-800">Experience #<span class="experience-number font-semibold">{{ forloop.counter }}</span></span>
                        </h3>
                         {% if formset.can_delete %}
                        <button type="button" class="btn btn-ghost btn-sm text-error hover:bg-error/10 formset-delete-btn" onclick="deleteForm(this, '{{ formset.prefix }}')">
                            <i class="fa-solid fa-trash-can mr-1"></i> Remove
                        </button>
                         {% endif %}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="form-control">
                            <label class="label" for="{{ form.job_title.id_for_label }}">
                                <span class="label-text font-medium">Job Title</span>
                                <span class="label-text-alt text-error">*</span>
                            </label>
                             {# Note: Removed explicit value attribute, widget_tweaks uses form field's value #}
                             {% render_field form.job_title class+="input input-bordered w-full pl-10 focus:border-primary focus:ring-1 focus:ring-primary" placeholder="e.g., Senior Software Engineer" required="required" %}
                             {% if form.job_title.errors %}<div class="text-error text-xs mt-1">{{ form.job_title.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="form-control">
                            <label class="label" for="{{ form.employer.id_for_label }}">
                                <span class="label-text font-medium">Employer/Company</span>
                                <span class="label-text-alt text-error">*</span>
                            </label>
                            {% render_field form.employer class+="input input-bordered w-full pl-10 focus:border-primary focus:ring-1 focus:ring-primary" placeholder="e.g., Google, Microsoft" required="required" %}
                            {% if form.employer.errors %}<div class="text-error text-xs mt-1">{{ form.employer.errors.0 }}</div>{% endif %}
                        </div>
                         <div class="form-control">
                            <label class="label" for="{{ form.location.id_for_label }}">
                                <span class="label-text font-medium">Location</span>
                                 <span class="label-text-alt text-error">*</span>
                            </label>
                            {% render_field form.location class+="input input-bordered w-full pl-10 focus:border-primary focus:ring-1 focus:ring-primary" placeholder="San Francisco, CA or Remote" required="required" %}
                             {% if form.location.errors %}<div class="text-error text-xs mt-1">{{ form.location.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="form-control">
                             <label class="label" for="{{ form.start_date.id_for_label }}">
                                <span class="label-text font-medium">Start Date</span>
                                <span class="label-text-alt text-error">*</span>
                             </label>
                             {# *** MODIFICATION: Removed explicit value attribute *** #}
                             {% render_field form.start_date type="date" class+="input input-bordered w-full pl-10 focus:border-primary focus:ring-1 focus:ring-primary" required="required" %}
                             {% if form.start_date.errors %}<div class="text-error text-xs mt-1">{{ form.start_date.errors.0 }}</div>{% endif %}
                        </div>
                         <div class="form-control end-date-container">
                             <label class="label" for="{{ form.end_date.id_for_label }}">
                                <span class="label-text font-medium">End Date</span>
                                <span class="label-text-alt text-gray-500">(Leave blank if current)</span>
                            </label>
                            {# *** MODIFICATION: Removed explicit value attribute *** #}
                            {% render_field form.end_date type="date" class+="input input-bordered w-full pl-10 focus:border-primary focus:ring-1 focus:ring-primary" %}
                             {% if form.end_date.errors %}<div class="text-error text-xs mt-1">{{ form.end_date.errors.0 }}</div>{% endif %}

                             <div class="form-control mt-2">
                                <label class="cursor-pointer label justify-start gap-3 py-1">
                                    {% render_field form.is_current class+="checkbox checkbox-primary checkbox-sm" onchange="toggleEndDate(this)" %}
                                    <span class="label-text">I currently work here</span>
                                </label>
                             </div>
                        </div>
                    </div>

                    {# --- Bullet Points Section (Corrected Access) --- #}
                    <div class="mt-6 bullet-points-container">
                         <div class="flex justify-between items-center mb-2">
                             <span class="font-medium">Responsibilities/Achievements</span>
                             <button type="button" class="btn btn-xs btn-primary text-white shadow-sm" onclick="openBulletGenerationModal('{{ forloop.counter0 }}')">
                                <i class="fa-solid fa-magic mr-1"></i> AI Generate
                             </button>
                         </div>
                         {# Hidden field for bullet count (used by JS) #}
                         <input type="hidden" name="bullet_count_{{ forloop.counter0 }}" value="{{ form.initial.bullet_points|length|default:0 }}" class="bullet-count" id="bullet_count_{{ forloop.counter0 }}">

                         <div class="bullet-points space-y-2 p-2 bg-gradient-to-b from-white to-gray-50 dark:from-gray-500/10 dark:to-gray-800/10 rounded-lg border border-gray-100 dark:border-gray-700 shadow-inner" id="bullet_points_container_{{ forloop.counter0 }}">
                             {# Loop over initial bullet points to render them #}
                             {% for bullet_item in form.initial.bullet_points %}
                                 {% include 'resumes/partials/bullet_point_form_row.html' with parent_index=forloop.parentloop.counter0 index=forloop.counter0 bullet_text=bullet_item.description %}
                             {% empty %}
                                 {# Render one empty bullet row if no initial bullets #}
                                 {% include 'resumes/partials/bullet_point_form_row.html' with parent_index=forloop.counter0 index=0 %}
                             {% endfor %}
                         </div>
                         <div class="flex justify-end mt-3">
                             {# Button to add more bullets via JS #}
                             <button type="button" class="btn btn-primary btn-sm hover:shadow-md" onclick="addBulletPoint('{{ forloop.counter0 }}')">
                                 <i class="fa-solid fa-plus mr-2"></i> Add Bullet Point
                             </button>
                         </div>
                    </div>
                    {# --- End Bullet Points --- #}

                </div> {# End form-row #}
                {% empty %}
                 <div class="bg-base-100 border border-gray-100 dark:border-gray-700 rounded-xl shadow p-8 text-center">
                    <p>No experience entries found or loaded. Use the button below to add one.</p>
                 </div>
                {% endfor %}
            </div> {# End experiences_container #}

            {# Template for adding new experience forms via JS (Simplified Example) #}
            <template id="{{ formset.prefix }}-form-template">
                 <div class="form-row bg-base-100 border border-gray-100 dark:border-gray-700 rounded-xl shadow-lg p-6 experience-entry" id="{{ formset.prefix }}-__prefix__-row" data-index="__prefix__">
                     <div class="hidden"><input type="checkbox" name="{{ formset.prefix }}-__prefix__-DELETE" id="id_{{ formset.prefix }}-__prefix__-DELETE"></div>
                     <div class="flex justify-between items-center mb-5 pb-3 border-b"><h3>New Entry</h3><button type="button" onclick="deleteForm(this, '{{ formset.prefix }}')">Remove</button></div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div><label>Job Title*</label><input type="text" name="{{ formset.prefix }}-__prefix__-job_title" required class="input input-bordered w-full"></div>
                        <div><label>Employer*</label><input type="text" name="{{ formset.prefix }}-__prefix__-employer" required class="input input-bordered w-full"></div>
                        <div><label>Location*</label><input type="text" name="{{ formset.prefix }}-__prefix__-location" required class="input input-bordered w-full"></div>
                        <div><label>Start Date*</label><input type="date" name="{{ formset.prefix }}-__prefix__-start_date" required class="input input-bordered w-full"></div>
                        <div><label>End Date</label><input type="date" name="{{ formset.prefix }}-__prefix__-end_date" class="input input-bordered w-full"><label><input type="checkbox" name="{{ formset.prefix }}-__prefix__-is_current" class="checkbox"> Current</label></div>
                     </div>
                     <div class="mt-6 bullet-points-container" id="bullet_points_container___prefix__">
                         <input type="hidden" name="bullet_count___prefix__" value="1" class="bullet-count">
                         {% include 'resumes/partials/bullet_point_form_row.html' with parent_index='__prefix__' index=0 bullet_text="" %} {# Include one empty bullet #}
                         <button type="button" onclick="addBulletPoint('__prefix__')">Add Bullet</button>
                     </div>
                 </div>
            </template>

            {# Add Experience button (for JS) #}
            <div class="flex justify-center mt-6">
                <button type="button" class="btn btn-primary add-another-btn" onclick="addForm(this, '{{ formset.prefix }}')">
                    <i class="fa-solid fa-plus mr-2"></i> Add Another Experience
                </button>
            </div>

        </div>

        <div class="w-full md:w-1/3 space-y-6">
             {# ... Keep your Tips content here ... #}
              <div class="bg-primary/5 border border-primary/10 rounded-lg p-4">
                <div class="flex items-start">
                    <div class="text-primary text-xl mr-4 mt-1">
                        <i class="fa-solid fa-lightbulb"></i>
                    </div>
                    <div>
                        <p class="text-base font-medium">Work Experience Tips</p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                            <strong>Tips:</strong> Start with your most recent position. Use action verbs and quantify your achievements with specific numbers (e.g., "Increased sales by 25%" rather than "Improved sales").
                        </p>
                    </div>
                </div>
            </div>
             <div class="bg-base-100 border border-gray-100 dark:border-gray-700 rounded-lg p-4">
                 {# ... Keep Action Verbs content ... #}
            </div>
        </div>
    </div>

    {# Navigation buttons are likely in wizard_base.html #}
</form>

{# Modals and Scripts #}
{% include 'resumes/partials/bullet_generation_modal.html' %}
{% include 'resumes/partials/bullet_enhancement_modal.html' %}
{# Ensure your JS file/block is included and handles formset logic (addForm, deleteForm, addBulletPoint etc.) correctly #}
<script>
    // Make sure your JS functions (addForm, deleteForm, toggleEndDate, addBulletPoint etc.)
    // correctly handle the formset prefixes and indices.
    // Example for addForm (ensure it uses the template correctly)
    function addForm(button, prefix) {
        const formContainer = document.getElementById('experiences_container'); // Target specific container
        const totalFormsInput = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
        const template = document.getElementById(prefix + '-form-template');
        if (!formContainer || !totalFormsInput || !template) { return; }
        const formNum = parseInt(totalFormsInput.value);
        let newFormHtml = template.innerHTML.replace(/__prefix__/g, formNum);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        const newFormElement = tempDiv.firstElementChild;
        formContainer.appendChild(newFormElement);
        totalFormsInput.value = formNum + 1;
        // Add focus logic etc. if needed
    }
    // Add other JS functions here or ensure they are in an included static file
     function deleteForm(button, prefix) {
        const formRow = button.closest('.form-row'); // Use .form-row class
        const deleteInput = formRow.querySelector('input[name$="-DELETE"]');

        if (deleteInput) { // Check if DELETE input exists
             // We are using formset_factory, so no existing instance check needed like modelformset
             // Always mark for potential deletion or remove directly if it's an extra form
             const isExtra = formRow.id.includes('__prefix__') || !formRow.querySelector('input[name$="-id"]')?.value; // Heuristic to check if it's an unsaved extra form

             if (!isExtra && deleteInput) {
                // Mark existing form for deletion
                 deleteInput.checked = true;
                 formRow.style.display = 'none'; // Hide instead of removing
                 console.log(`Marked form ${formRow.id} for deletion.`);
             } else {
                 // Remove an extra, unsaved form row directly
                 console.log(`Removing extra form row ${formRow.id}`);
                 formRow.remove();
                 // Optional: Renumber forms if needed by subsequent JS logic
                 // Optional: Decrement TOTAL_FORMS if removing an extra row (formset should handle this on POST)
                 // If you decrement here, ensure formset validation doesn't complain later
             }

        } else {
             console.error("Could not find DELETE input for prefix:", prefix, "in row:", formRow);
             // Fallback: Remove the row visually anyway if delete doesn't work
             formRow.remove();
        }
        // Optionally update UI or counts if needed
    }
     function toggleEndDate(checkbox) {
        const formRow = checkbox.closest('.form-row');
        if (!formRow) return;
        const endDateContainer = formRow.querySelector('.end-date-container'); // Find parent container
        if (!endDateContainer) return;
        const endDateInput = endDateContainer.querySelector('input[type="date"]');
        if (endDateInput) {
             endDateInput.disabled = checkbox.checked;
             if (checkbox.checked) {
                 endDateInput.value = ''; // Clear end date if current
                 endDateInput.required = false; // Make not required
             } else {
                 endDateInput.required = false; // Set required status based on your form definition (might not be required anyway)
             }
        }
     }
    // Add functions for addBulletPoint, removeBulletPoint, etc. ensuring they
    // use the correct parent index passed to them.
     function addBulletPoint(parentIndex) {
        const container = document.getElementById(`bullet_points_container_${parentIndex}`); // Target specific container
        if(!container) return;
        const bulletCountInput = document.getElementById(`bullet_count_${parentIndex}`);
        let bulletIndex = parseInt(bulletCountInput.value);

         // You might need to fetch the template via HTMX or have it inline
         // For simplicity, creating basic textarea:
         const newBulletRow = document.createElement('div');
         newBulletRow.className = 'bullet-point-row flex items-start gap-3'; // Add necessary classes
         newBulletRow.innerHTML = `
             <div class="mt-3 text-primary">•</div>
             <div class="form-control flex-1">
                 <textarea name="bullet_${parentIndex}_${bulletIndex}" class="textarea textarea-bordered w-full"></textarea>
             </div>
             <button type="button" class="btn btn-xs btn-ghost text-error" onclick="removeBulletPoint(this, '${parentIndex}')">X</button>
         `; // Add appropriate classes and structure matching your partial

        container.appendChild(newBulletRow);
        bulletCountInput.value = bulletIndex + 1;
     }
     // Add removeBulletPoint logic similar to deleteForm or your skills version

</script>
{% endblock %}